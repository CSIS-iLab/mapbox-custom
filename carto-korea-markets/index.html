<!DOCTYPE html>
<html>
<head>
<title>Category Filter | CARTO</title>
<meta name="viewport" content="initial-scale=1.0">
<meta charset="utf-8">
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,600,700|Open+Sans:300,400,600" rel="stylesheet">
<!-- Include Leaflet -->
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
<link href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" rel="stylesheet">
<!-- Include CARTO.js -->
<script src="https://libs.cartocdn.com/carto.js/v4.1.1/carto.min.js"></script>
<link href="https://carto.com/developers/carto-js/examples/maps/public/style.css" rel="stylesheet">
</head>
<body>
<div id="map"></div>
<aside class="toolbox">
<div class="box">
  <header>
    <h1>Private Markets in North Korea</h1>
    <button class="github-logo js-source-link"></button>
  </header>

  <section>
    <p class="description open-sans">One of the most significant developments in North Korea over the past two decades has been the growth of markets. This map provides a broad view of the geographical location of markets across North Korea.  Each dot represents one market.</p>

    <div class="separator"></div>

    <section class="usage">
      <header>USAGE</header>
      <p class="open-sans">Overlay borders of North Korean provinces and counties.</p>
    </section>

    <div id="controls">
      <div id="info">
        <h3>Administrative Regions</h3>
      </div>
      <ul>
        <li>
          <input type="checkbox" name="roomTypes[]" id="entire" value="Entire home/apt" checked>
          <label for="entire">Provinces (Gun 군) </label>
        </li>
        <li>
          <input type="checkbox" name="roomTypes[]" id="private" value="Private room" checked>
          <label for="private">Counties (Do 도)</label>
        </li>
      </ul>
    </div>
  </section>

  <footer class="js-footer"></footer>
</div>
</aside>

<script>
function getSelectedRoomTypes () {
  const inputControls = document.querySelectorAll('#controls input');
  const values = [];

  inputControls.forEach(input => input.checked ? values.push(input.value): null);
  return values;
}

function applyFilters () {
  roomTypeFilter.setFilters({ in: getSelectedRoomTypes() });
  // or
  // roomTypeFilter.set('in', getSelectedRoomTypes());
}

function registerListeners () {
  document.querySelectorAll('#controls input').forEach(
    input => input.addEventListener('click', () => applyFilters())
  );
}

const map = L.map('map').setView([39.7952701,126.5886823], 7);
map.scrollWheelZoom.disable();

L.tileLayer('https://api.mapbox.com/styles/v1/ilabmedia/cjk40a37x21ha2skptjecv1j0/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiaWxhYm1lZGlhIiwiYSI6ImNpbHYycXZ2bTAxajZ1c2tzdWU1b3gydnYifQ.AHxl8pPZsjsqoz95-604nw', {
  maxZoom: 14
}).addTo(map);

const client = new carto.Client({
  apiKey: 'oOq5nIiQ2_kKSBDowFLCPg',
  username: 'csis'
});

const markets = new carto.source.Dataset('dprkmarkets_by_geocoordinates');
      const style_markets = new carto.style.CartoCSS(`
        #layer {
  marker-width: ramp([estimated_revenue_usd], range(4, 10), quantiles(5));
  marker-fill: #f2c730;
  marker-fill-opacity: 1;
  marker-allow-overlap: true;
  marker-line-width: 1;
  marker-line-color: #000000;
  marker-line-opacity: 1;
  marker-comp-op: screen;
}
      `);
      const layer_markets = new carto.layer.Layer(markets, style_markets);

      client.addLayer(layer_markets);
      client.getLeafletLayer().addTo(map);

//const roomTypeFilter = new carto.filter.Category('room_type', { in: getSelectedRoomTypes() });

//const source = new carto.source.SQL('SELECT * FROM dprkmarkets_by_geocoordinates');
//source.addFilter(roomTypeFilter);

//const style = new carto.style.CartoCSS(`
//  #layer {
//    marker-width: 7;
//    marker-fill: #EE4D5A;
//    marker-line-color: #FFFFFF;
//    marker-fill: ramp([room_type], (#88CCEE, #CC6677, #DDCC77), ("Entire home/apt", "Private room", "Shared room"), "=");
//  }
//`);
//const layer = new carto.layer.Layer(source, style);

//client.addLayer(layer);
//client.getLeafletLayer().addTo(map);

registerListeners();
</script>
</body>
</html>
